name: Redeploy HashiCorp Vault service

on:
  workflow_dispatch:
    inputs:
      logLevel: 
        description: 'Log level'
        required: true 
        default: 'warning'
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  redeploy_vault:
    runs-on: ["self-hosted", "ub22"]

    steps:
      - name: Check out repository code
        uses: actions/checkout@v2

      - name: Setup Vault Address
        run: echo "VAULT_ADDR=${{ secrets.VAULT_ADDR }}" >> $GITHUB_ENV

      - name: Redeploy Vault using Nginx
        run: |
          # Restart our Vault service and Nginx
          echo "Restarting Vault service, Nginx web server and reverse proxy"        
          sudo systemctl daemon-reload 
          sudo systemctl restart vault        
          sudo systemctl restart nginx
          echo "SUCCESS: Services restarted."        

      - name: Unseal Vault
        run: |
          VAULT_ADDR='https://vault.thecodemountains.com:8443'
          echo $VAULT_ADDR

          vault operator unseal Uj77x5+BEOZUfE7mgt0CzqbvCg5jtRNTDPh/Hoa7GWcM
          vault operator unseal hbZv9Ag5naQFP6Q0meuPRVUIGB4VxyutdFQkBdSaWOEK
          vault operator unseal OtIlRqSLZYEWNvkCAGGbVIBaxpzb6wKP7rVv049Uf4yN

          echo "SUCCESS: Vault unsealed successfully"
          vault status
